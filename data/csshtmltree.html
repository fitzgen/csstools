<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="author" content="Joe Walker">
  <link rel="stylesheet" type="text/css" href="csshtmltree.css" />
  <link rel="stylesheet" type="text/css" href="css/smoothness/jquery-ui-1.8.6.custom.css" />
</head>
<body role="application" class="">

<div id="tabs">
  <ul>
    <li><a href="#inspector">Inspector</a></li>
    <li><a href="#doctor">Doctor</a></li>
    <li><a href="#checker">Checker</a></li>
  </ul>

  <!-- The output from #templateInspector (below) is inserted here. -->
  <div id="inspector">
    <div id="rootInspector">
    </div>

    <!--
    templateRoot sits at the top of the window showing what we're looking at.
    For data it needs an instance of CssHtmlTree from which it gets styleGroups
    -->
    <div id="templateInspector" class="template">
      <div _id="groups">
        <!-- TODO: using a custom open attr is a bit nasty but it fits with the
        XUL way of doing things. Should we 'class'ify this? -->
        <div foreach="group in ${styleGroups}" class="group" open="false"
              save="${group.element}">
          <h1 _onclick="${group.click}">${group.localName}</h1>
          <div save="${group.properties}"></div>
        </div>
      </div>
    </div>

    <!--
    A templateProperties sits inside each templateGroups to show the properties
    themselves. Each needs data like this:
    {
      propertyViews: [ ..., ] // Array of PropertyViews from csshtmltree.js
    }
    -->
    <div id="templateProperties" class="template">
      <div foreach="property in ${propertyViews}" class="property-view"
          open="false" save="${property.element}">
        <div class="clearfix property-header" _onclick="${property.click}">
          <span class="property-name">
            <!-- TODO: the title probably needs l10n work -->
            <a class="link" target="_blank" href="${property.link}"
                title="Read the docs for this property">${property.name}</a>
          </span>
          <span class="property-value">${property.value}</span>
          <span class="rule-count link">${property.matchesTitle}</span>
        </div>
        <table class="selectors" save="${property.selectorsEle}"></table>
      </div>
    </div>
  
    <!--
    A templateSelectors sits inside each templateProperties showing the list of
    the selectors that affect the property. Each needs data an object containing
    a selectorViews property which is an array of SelectorViews
    This is a template so the parent does not need to be a table, except that
    using a div a the parent causes the DOM to muck with the tr elements
    -->
    <table id="templateSelectors" class="template selectors">
      <tr foreach="selector in ${selectorViews}">
        <td class="rule-text status${selector.status}">${selector.selector}</td>
        <td class="rule-value">${selector.value}</td>
        <td class="rule-link">
          <a title="${selector.href}" href="view-source:${selector.href}"
              target="_blank" class="link">${selector.shortSource}</a>
        </td>
      </tr>
      <tr if="${showUnmatched}">
        <td colspan="4">
          <a href="#" _onclick="${showUnmatchedLinkClick}"
              class="link">${showUnmatchedLinkText}</a>
        </td>
      </tr>
    </table>
  </div>

  <div id="doctor">
    <div id="rootDoctor">
    </div>

    <!--
    templateDoctor needs an instance of CssHtmlTree from which it gets sheets
    -->
    <div id="templateDoctor" class="template">
      <p>Where is the rule to diagnose?</p>
      <div foreach="sheet in ${sheets}" class="sheet" open="false"
            save="${sheet.element}">
        <h1 _onclick="${sheet.click}"
            title="${sheet.href}">${sheet.shortSource} (${sheet.ruleTitle})</h1>
        <div save="${sheet.rulesEle}"></div>
      </div>
    </div>

    <!--
    A templateRules sits inside each templateProperties showing the list of the
    selectors that affect the property. Each needs data an object containing
    a selectorViews property which is an array of SelectorViews
    This is a template so the parent does not need to be a table, except that
    using a div a the parent causes the DOM to muck with the tr elements
    -->
    <div id="templateRules" class="template rules">
      <div foreach="rule in ${ruleViews}" class="rule-view"
          open="false" save="${rule.element}">
        <div class="clearfix rule-header" _onclick="${rule.click}">
          <span class="rule-name">${rule.name}</span>
          <span class="rule-value">${rule.value}</span>
          <span class="rule-count link">${rule.propertiesTitle}</span>
        </div>
        <table class="properties" save="${rule.propertiesEle}"></table>
      </div>
    </div>
  </div>

  <div id="checker">
    <p>
    One day this tab will host a list of the known CSS errors and for each
    a proposed fix. We might promote this tab to the first tab and hide it if
    there are no errors because it might not make sense to be tweaking unless
    you have fixed all your errors.
    <p>
    We may need a "Yes I know about this, shut-up button".
  </div>

</div>

<script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.6.custom.min.js"></script>
<script type="text/javascript">
/* Initialize the JQueryUI tabs */
$(function(){ $('#tabs').tabs(); });
</script>

<script type="text/javascript;version=1.8" src="proxierClient.js"></script>
<script type="text/javascript;version=1.8" src="domtemplate.js"></script>
<script type="text/javascript;version=1.8">
/**
 * If the proxier doesn't work, it's probably because this HTML is being read
 * using a file:// URL for debugging. Rather than fail we use a test back-end
 */
if (!proxier.active) {
  console.log("csshtmltree fallback");
}
var oldRequireWhenInactive = proxier._requireWhenInactive;
proxier._requireWhenInactive = function(scopeName) {
  if (scopeName !== "styleLogic") {
    return oldRequireWhenInactive(scopeName);
  }

  return {
    /**
     * Report on the stylesheets attached to the current page.
     */
    getSheets: function(callback)
    {
      console.log("fake getSheets()");
      callback([
        {
          systemSheet: false, index: 0, shortSource: "styles.css", ruleCount: 10,
          href: "http://example.com/page/styles.css",
        },
        {
          systemSheet: false, index: 1, shortSource: "global.css", ruleCount: 15,
          href: "http://example.com/global.css",
        }
      ]);
    },

    getRules: function(sheetHref, callback)
    {
      callback([
        { selectorGroup: [ ".group h1", ".sheet h1" ], propertyCount: 3 },
        { selectorGroup: [ "error" ], propertyCount: 1 },
        { selectorGroup: [ "content" ], propertyCount: 5 }
      ]);
    },

    /**
     * The user is looking at a property (or properties) at a glance; this
     * returns a map (or maps, one for each property) that details the computed
     * value of the property, and the number of CSS rules that 'match'.
     */
    getPropertyInfo: function(aProperty, callback)
    {
      console.log("fake getPropertyInfo(" + aProperty + ")");

      function build(prop) {
        return {
          property: prop,
          value: 'value',
          matchedRuleCount: 1
        };
      }

      if (Array.isArray(aProperty)) {
        callback(aProperty.map(function(p) {
          return build(p);
        }));
      }
      else {
        callback(build(aProperty));
      }
    },
  
    /**
     * Return an array of rule objects where we know that the rule selectors
     * either directly affect the highlighted element, or one of it's parents.
     */
    getSelectors: function(aProperty, aMatched, callback) {
      console.log("fake getPropertyInfo(" + aProperty + ", " + aMatched + ")");
      callback([
        {
          line: 20,
          href: "http://example.com/page/styles.css",
          shortSource: "styles:20",
          value: "red",
          status: 2,
          important: false,
          property: aProperty,
          selector: "body a"
        }
      ]);
    }
  };
};
</script>
<script type="text/javascript;version=1.8" src="csshtmltree.js"></script>

</body>
</html>

